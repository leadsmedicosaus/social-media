<div class="mt-4"></div>
<div style="max-width: 900px; margin: 0 auto;">

    {% for post in posts %}
    <article x-data="dropZone({{ post.id }})">
        <div style="display: flex; justify-content: end;">
            <small class="pico-color-slate-450">{{ post.scheduled_on }}</small>
        </div>

        <p style="white-space: pre-line;">{{ post.description }}</p>

        <!-- Drop zone for new image -->
        <div 
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop($event)"
            :class="isDragging ? 'drop-zone-active' : ''"
            style="position: relative; min-height: 100px; border-radius: 8px; transition: all 0.2s;"
        >
            <!-- Upload overlay -->
            <div x-show="isDragging" style="position: absolute; inset: 0; background: rgba(0, 200, 150, 0.3); border: 3px dashed #00c896; border-radius: 8px; display: flex; align-items: center; justify-content: center; z-index: 10;">
                <span style="color: #00c896; font-weight: bold; font-size: 1.2rem;">üì∑ Solte a imagem aqui</span>
            </div>
            
            <!-- Uploading indicator -->
            <div x-show="isUploading" style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); border-radius: 8px; display: flex; align-items: center; justify-content: center; z-index: 10;">
                <span style="color: white;" aria-busy="true">Enviando...</span>
            </div>

            {% if post.media_file %}
                {% if post.has_image %}
                <div x-data="{fullScreen: false}" style="display: flex; justify-content: center;">
                    <div x-show="!fullScreen">
                        <img @click="fullScreen = true" :src="newImageUrl || '{{ post.media_file.url }}'" alt="Media file"
                            style="max-width: 100%; height: 350px; object-fit: contain; margin-bottom: 1rem; margin-top: 1rem; border-radius: 5px; cursor: pointer;">
                    </div>

                    <dialog :open="fullScreen" @click="fullScreen = false">
                        <img :src="newImageUrl || '{{ post.media_file.url }}'" alt="Media file"
                            style="max-width: 100%; height: 100%; object-fit: contain; margin-bottom: 1rem; margin-top: 1rem; border-radius: 5px;">
                    </dialog>
                </div>
                {% endif %}
        
                {% if post.has_video %}
                <div x-data="{fullScreen: false}" style="display: flex; justify-content: center;">
                    <div x-show="!fullScreen">
                        <video @click="fullScreen = true" controls
                            style="max-width: 100%; height: 350px; object-fit: contain; margin-bottom: 1rem; margin-top: 1rem; border-radius: 5px;">
                            <source src="{{ post.media_file.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>

                    <dialog :open="fullScreen" @click="fullScreen = false">
                        <video controls
                            style="max-width: 100%; height: 100%; object-fit: contain; margin-bottom: 1rem; margin-top: 1rem; border-radius: 5px;">
                            <source src="{{ post.media_file.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </dialog>
                </div>
                {% endif %}
            {% else %}
                <div style="display: flex; justify-content: center; align-items: center; height: 150px; border: 2px dashed #666; border-radius: 8px; margin: 1rem 0;">
                    <span class="pico-color-slate-500">Arraste uma imagem aqui</span>
                </div>
            {% endif %}
        </div>

        <!-- Success message -->
        <div x-show="uploadSuccess" x-transition style="text-align: center; color: #00c896; margin-top: 0.5rem;">
            ‚úÖ Imagem atualizada!
        </div>

        <!-- Error message -->
        <div x-show="uploadError" x-transition style="text-align: center; color: #ff6b6b; margin-top: 0.5rem;">
            ‚ùå Erro ao enviar imagem
        </div>

        <div class="mt-1">

            <p class="pico-color-slate-450">Links:</p>

            <div style="display: flex; align-items: center; gap: 1rem; margin-top: -15px;">

                <!-- Instagram -->
                {% if post.error_instagram %}
                    <span data-tooltip="Retries {{ post.retries_instagram }}/10. Got error: {{ post.error_instagram }}" class="pico-color-red-500">
                        <i class="bi bi-instagram"></i>
                    </span>
                {% elif post.link_instagram %}
                    <a data-tooltip="posted" target="_blank" href="{{ post.link_instagram }}">
                        <i class="bi bi-instagram"></i>
                    </a>
                {% elif post.post_on_instagram %}
                    <span data-tooltip="pending">
                        <i class="bi bi-instagram"></i>
                    </span>
                {% endif %}

                <!-- Facebook -->
                {% if post.error_facebook %}
                    <span data-tooltip="Retries {{ post.retries_facebook }}/10. Got error: {{ post.error_facebook }}" class="pico-color-red-500">
                        <i class="bi bi-facebook"></i>
                    </span>
                {% elif post.link_facebook %}
                    <a data-tooltip="posted" target="_blank" href="{{ post.link_facebook }}">
                        <i class="bi bi-facebook"></i>
                    </a>
                {% elif post.post_on_facebook %}
                    <span data-tooltip="pending">
                        <i class="bi bi-facebook"></i>
                    </span>
                {% endif %}

                <!-- X -->
                {% if post.error_x %}
                    <span data-tooltip="Retries {{ post.retries_x }}/10. Got error: {{ post.error_x }}" class="pico-color-red-500">
                        <i class="bi bi-twitter-x"></i>
                    </span>
                {% elif post.link_x %}
                    <a data-tooltip="posted" target="_blank" href="{{ post.link_x }}">
                        <i class="bi bi-twitter-x"></i>
                    </a>
                {% elif post.post_on_x %}
                    <span data-tooltip="pending">
                        <i class="bi bi-twitter-x"></i>
                    </span>
                {% endif %}

                <!-- Linkedin -->
                {% if post.error_linkedin %}
                    <span data-tooltip="Retries {{ post.retries_linkedin }}/10. Got error: {{ post.error_linkedin }}" class="pico-color-red-500">
                        <i class="bi bi-linkedin"></i>
                    </a>
                {% elif post.link_linkedin %}
                    <a data-tooltip="posted" target="_blank" href="{{ post.link_linkedin }}">
                        <i class="bi bi-linkedin"></i>
                    </a>
                {% elif post.post_on_linkedin %}
                    <span data-tooltip="pending">
                        <i class="bi bi-linkedin"></i>
                    </span>
                {% endif %}

                <!-- TikTok -->
                {% if post.error_tiktok %}
                    <span data-tooltip="Retries {{ post.retries_tiktok }}/10. Got error: {{ post.error_tiktok }}" class="pico-color-red-500">
                        <i class="bi bi-tiktok"></i>
                    </a>
                {% elif post.link_tiktok %}
                    <a data-tooltip="posted" target="_blank" href="{{ post.link_tiktok }}">
                        <i class="bi bi-tiktok"></i>
                    </a>
                {% elif post.post_on_tiktok %}
                    <span data-tooltip="pending">
                        <i class="bi bi-tiktok"></i>
                    </span>
                {% endif %}

            </div>

        </div>


        <div style="display: flex; gap: 1rem; justify-content: end;">
            <a href="{% url 'schedule_edit' post_id=post.id %}" class="pico-color-jade-500" style="text-decoration: none;">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href="{% url 'schedule_delete' post_id=post.id %}" class="pico-color-red-500" style="text-decoration: none;">
                <i class="bi bi-trash"></i> Delete
            </a>
        </div>


    </article>
    {% endfor %}

</div>

<script>
function dropZone(postId) {
    return {
        postId: postId,
        isDragging: false,
        isUploading: false,
        uploadSuccess: false,
        uploadError: false,
        newImageUrl: null,

        async handleDrop(event) {
            this.isDragging = false;
            
            const files = event.dataTransfer.files;
            if (files.length === 0) return;
            
            const file = files[0];
            
            // Check if it's an image or video
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                this.uploadError = true;
                setTimeout(() => this.uploadError = false, 3000);
                return;
            }
            
            this.isUploading = true;
            this.uploadSuccess = false;
            this.uploadError = false;
            
            const formData = new FormData();
            formData.append('media_file', file);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}');
            
            try {
                const response = await fetch(`/schedule-update-media/${this.postId}/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.newImageUrl = data.media_url;
                    this.uploadSuccess = true;
                    setTimeout(() => this.uploadSuccess = false, 3000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                this.uploadError = true;
                setTimeout(() => this.uploadError = false, 3000);
            } finally {
                this.isUploading = false;
            }
        }
    }
}
</script>
